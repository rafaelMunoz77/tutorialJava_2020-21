<html>
<head>
<title>Curso - Programación de un Space Invaders en Java</title>

</head>
<body>

<link rel="stylesheet" type="text/css" href="estilos.css">


<h1>Curso - Programación de un Space Invaders en Java</h1>
<table border="0" width="100%">
<tr>
  <td width="33%" align="center">&nbsp;
    
    <a href="JAVA-INVADERS-28.html"> 
    
    Página Anterior - 
    
    Corrigiendo los fallos de sonido
    </a>
   
  </td>
  <td width="33%" align="center"><b>
    
    Página Actual - 
    
    29 - Pequeñas optimizaciones</b>
  </td>
  <td width="33%" align="center">&nbsp;
    
  </td>    
</tr>
<tr>
<tr>
  <td>&nbsp;</td>
  <td align="center"><a href="index.html">Índice del curso</a></td>
  <td>&nbsp;</td>
</tr>
</table>
<hr>
 
<link rel="stylesheet" href="codigo.css" />
<h2>Pequeñas optimizaciones</h2>
<p class=autor> (c) Alexander Hristov </p>

<p>En nuestra última versión, realizaremos algunas pequeñas optimizaciones que nos ayudarán a incrementar nuestros
fotogramas por segundo, dañadas desde que implementamos el sonido y las texturas.</p>

<p>La primera optimización consiste en utilizar imágenes en formato "<span class="kw">compatible</span>". ¿Qué significa
esto? Una imagen "compatible" es una imagen en memoria que tiene las mismas características (o al menos muy similares)
al modo de vídeo nativo que se está mostrando en ese momento - en términos de bits por pixel, transparencia, etc. Las
imágenes compatibles son mucho más rápidas de dibujar que cualquier otro formato. Ahora mismo lo que estamos haciendo
es utilizar el formato que a ImageIO le apetezca devolvernos. Podemos optimizar esto de la siguiente forma:</p>
<ol>
 <li>Leemos la imagen de disco utilizando ImageIO</li>
 <li>Creamos una imagen compatible del mismo tamaño que la imagen leida</li>
 <li>Pintamos la imagen recién cargada encima de la imagen compatible</li>
</ol>
De esta forma obtenemos una "versión compatible" de una imagen situada en el disco</p>

<p>Haremos todo esto en la clase <span class="clase">SpriteCache</span>, que es la que centraliza el acceso a las
imágenes: </p>

<div class='codigo'>
<TABLE id="Header" border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td colspan="2" width="33%">&nbsp;</td>
<td align="center" colspan="2" width="33%">
<font size="4">SpriteCache.java</font>
</td>
<td align="right" colspan="2" width="33%">&nbsp;</td>
</tr>
</TABLE>
<pre ID="Classes">

<FONT ID="LN">1     </FONT><A NAME="1"></A><FONT ID="FormalComment">/**
<FONT ID="LN">2     </FONT><A NAME="2"></A> * Curso Básico de desarrollo de Juegos en Java - Invaders
<FONT ID="LN">3     </FONT><A NAME="3"></A> * 
<FONT ID="LN">4     </FONT><A NAME="4"></A> * (c) 2004 Planetalia S.L. - Todos los derechos reservados. Prohibida su reproducción
<FONT ID="LN">5     </FONT><A NAME="5"></A> * 
<FONT ID="LN">6     </FONT><A NAME="6"></A> * http://www.planetalia.com
<FONT ID="LN">7     </FONT><A NAME="7"></A> * 
<FONT ID="LN">8     </FONT><A NAME="8"></A> */</FONT>
<FONT ID="LN">9     </FONT><A NAME="9"></A><FONT ID="Package">package</FONT> version29;
<FONT ID="LN">10    </FONT><A NAME="10"></A>
<FONT ID="LN">11    </FONT><A NAME="11"></A><FONT ID="Import">import</FONT> java.awt.Graphics;
<FONT ID="LN">12    </FONT><A NAME="12"></A><FONT ID="Import">import</FONT> java.awt.GraphicsConfiguration;
<FONT ID="LN">13    </FONT><A NAME="13"></A><FONT ID="Import">import</FONT> java.awt.GraphicsEnvironment;
<FONT ID="LN">14    </FONT><A NAME="14"></A><FONT ID="Import">import</FONT> java.awt.Image;
<FONT ID="LN">15    </FONT><A NAME="15"></A><FONT ID="Import">import</FONT> java.awt.Transparency;
<FONT ID="LN">16    </FONT><A NAME="16"></A><FONT ID="Import">import</FONT> java.awt.image.BufferedImage;
<FONT ID="LN">17    </FONT><A NAME="17"></A><FONT ID="Import">import</FONT> java.awt.image.ImageObserver;
<FONT ID="LN">18    </FONT><A NAME="18"></A><FONT ID="Import">import</FONT> java.net.URL;
<FONT ID="LN">19    </FONT><A NAME="19"></A><FONT ID="Import">import</FONT> javax.imageio.ImageIO;
<FONT ID="LN">20    </FONT><A NAME="20"></A>
<FONT ID="LN">21    </FONT><A NAME="21"></A><FONT ID="Public">public</FONT> <FONT ID="Class">class</FONT> SpriteCache <FONT ID="Extends">extends</FONT> <A TITLE='Java Source' HREF="version29/ResourceCache.java.html">ResourceCache</A> <FONT ID="Implements">implements</FONT> ImageObserver{
<FONT ID="LN">22    </FONT><A NAME="22"></A>  
<FONT ID="LN">23    </FONT><A NAME="23"></A>  <FONT ID="Protected">protected</FONT> Object loadResource(URL url) {
<FONT ID="LN">24    </FONT><A NAME="24"></A>    <FONT ID="Try">try</FONT> {
<FONT ID="LN">25    </FONT><A NAME="25"></A>      <FONT ID="Return">return</FONT> ImageIO.read(url);
<FONT ID="LN">26    </FONT><A NAME="26"></A>    } <FONT ID="Catch">catch</FONT> (Exception e) {
<FONT ID="LN">27    </FONT><A NAME="27"></A>      System.out.println(<FONT ID="StringLiteral">"No se pudo cargar la imagen de "</FONT>+url);
<FONT ID="LN">28    </FONT><A NAME="28"></A>      System.out.println(<FONT ID="StringLiteral">"El error fue : "</FONT>+e.getClass().getName()+<FONT ID="StringLiteral">" "</FONT>+e.getMessage());
<FONT ID="LN">29    </FONT><A NAME="29"></A>      System.exit(<FONT ID="IntegerLiteral">0</FONT>);
<FONT ID="LN">30    </FONT><A NAME="30"></A>      <FONT ID="Return">return</FONT> <FONT ID="Null">null</FONT>;
<FONT ID="LN">31    </FONT><A NAME="31"></A>    }
<FONT ID="LN">32    </FONT><A NAME="32"></A>  }
<FONT ID="LN">33    </FONT><A NAME="33"></A>  
<FONT ID="LN">34    </FONT><A NAME="34"></A>  <FONT ID="Public">public</FONT> BufferedImage createCompatible(<FONT ID="Int">int</FONT> width, <FONT ID="Int">int</FONT> height, <FONT ID="Int">int</FONT> transparency) {
<FONT ID="LN">35    </FONT><A NAME="35"></A>    GraphicsConfiguration gc = 
<FONT ID="LN">36    </FONT><A NAME="36"></A>      GraphicsEnvironment.getLocalGraphicsEnvironment().getDefaultScreenDevice().getDefaultConfiguration();
<FONT ID="LN">37    </FONT><A NAME="37"></A>    BufferedImage compatible = gc.createCompatibleImage(width,height,transparency);
<FONT ID="LN">38    </FONT><A NAME="38"></A>    <FONT ID="Return">return</FONT> compatible;
<FONT ID="LN">39    </FONT><A NAME="39"></A>  }
<FONT ID="LN">40    </FONT><A NAME="40"></A>  
<FONT ID="LN">41    </FONT><A NAME="41"></A>  <FONT ID="Public">public</FONT> BufferedImage getSprite(String name) {
<FONT ID="LN">42    </FONT><A NAME="42"></A>    BufferedImage loaded = (BufferedImage)getResource(name);
<FONT ID="LN">43    </FONT><A NAME="43"></A>    BufferedImage compatible = createCompatible(loaded.getWidth(),loaded.getHeight(),Transparency.BITMASK); 
<FONT ID="LN">44    </FONT><A NAME="44"></A>    Graphics g = compatible.getGraphics();
<FONT ID="LN">45    </FONT><A NAME="45"></A>    g.drawImage(loaded,<FONT ID="IntegerLiteral">0</FONT>,<FONT ID="IntegerLiteral">0</FONT>,<FONT ID="This">this</FONT>);
<FONT ID="LN">46    </FONT><A NAME="46"></A>    <FONT ID="Return">return</FONT> compatible;
<FONT ID="LN">47    </FONT><A NAME="47"></A>  }
<FONT ID="LN">48    </FONT><A NAME="48"></A>    
<FONT ID="LN">49    </FONT><A NAME="49"></A>  <FONT ID="Public">public</FONT> <FONT ID="Boolean">boolean</FONT> imageUpdate(Image img, <FONT ID="Int">int</FONT> infoflags,<FONT ID="Int">int</FONT> x, <FONT ID="Int">int</FONT> y, <FONT ID="Int">int</FONT> w, <FONT ID="Int">int</FONT> h) {
<FONT ID="LN">50    </FONT><A NAME="50"></A>     <FONT ID="Return">return</FONT> (infoflags &amp; (ALLBITS|ABORT)) == <FONT ID="IntegerLiteral">0</FONT>;
<FONT ID="LN">51    </FONT><A NAME="51"></A>  }
<FONT ID="LN">52    </FONT><A NAME="52"></A>}
<FONT ID="LN">53    </FONT><A NAME="53"></A>
</div>


<p>La segunda optimización consiste en librarnos del dibujo repetitivo de texturas dentro del bucle principal. En su
lugar, procederemos de la siguiente forma: Nada mas arrancar el juego, creamos una imagen en memoria que tiene la misma
anchura que la pantalla, pero con una altura igual a la de la pantalla mas el tamaño de la textura. Rellenamos esta
imagen con el fondo que queremos utilizar. Durante el juego, simplemente copiamos una sub-imagen de esta imagen en memoria
a la pantalla. El efecto de scroll se consigue variando la coordenada Y de inicio de la sub-imagen que pintamos. Esto
nos permite limitar el uso de TexturePaint - que siempre es muy lento- a una única vez, y además fuera del bucle
principal del juego: </p>

<div class='codigo'>
<TABLE id="Header" border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td colspan="2" width="33%">&nbsp;</td>
<td align="center" colspan="2" width="33%">
<font size="4">Invaders.java</font>
</td>
<td align="right" colspan="2" width="33%">&nbsp;</td>
</tr>
</TABLE>
<pre ID="Classes">

<FONT ID="LN">1     </FONT><A NAME="1"></A><FONT ID="Package">package</FONT> version29;
<FONT ID="LN">2     </FONT><A NAME="2"></A><FONT ID="FormalComment">/**
<FONT ID="LN">3     </FONT><A NAME="3"></A> * Curso Básico de desarrollo de Juegos en Java - Invaders
<FONT ID="LN">4     </FONT><A NAME="4"></A> * 
<FONT ID="LN">5     </FONT><A NAME="5"></A> * (c) 2004 Planetalia S.L. - Todos los derechos reservados. Prohibida su reproducción
<FONT ID="LN">6     </FONT><A NAME="6"></A> * 
<FONT ID="LN">7     </FONT><A NAME="7"></A> * http://www.planetalia.com
<FONT ID="LN">8     </FONT><A NAME="8"></A> * 
<FONT ID="LN">9     </FONT><A NAME="9"></A> */</FONT>
<FONT ID="LN">10    </FONT><A NAME="10"></A>
<FONT ID="LN">11    </FONT><A NAME="11"></A><FONT ID="Import">import</FONT> java.awt.Canvas;
<FONT ID="LN">12    </FONT><A NAME="12"></A><FONT ID="Import">import</FONT> java.awt.Color;
<FONT ID="LN">13    </FONT><A NAME="13"></A><FONT ID="Import">import</FONT> java.awt.Cursor;
<FONT ID="LN">14    </FONT><A NAME="14"></A><FONT ID="Import">import</FONT> java.awt.Dimension;
<FONT ID="LN">15    </FONT><A NAME="15"></A><FONT ID="Import">import</FONT> java.awt.Font;
<FONT ID="LN">16    </FONT><A NAME="16"></A><FONT ID="Import">import</FONT> java.awt.Graphics2D;
<FONT ID="LN">17    </FONT><A NAME="17"></A><FONT ID="Import">import</FONT> java.awt.Point;
<FONT ID="LN">18    </FONT><A NAME="18"></A><FONT ID="Import">import</FONT> java.awt.Rectangle;
<FONT ID="LN">19    </FONT><A NAME="19"></A><FONT ID="Import">import</FONT> java.awt.TexturePaint;
<FONT ID="LN">20    </FONT><A NAME="20"></A><FONT ID="Import">import</FONT> java.awt.Toolkit;
<FONT ID="LN">21    </FONT><A NAME="21"></A><FONT ID="Import">import</FONT> java.awt.Transparency;
<FONT ID="LN">22    </FONT><A NAME="22"></A><FONT ID="Import">import</FONT> java.awt.event.KeyEvent;
<FONT ID="LN">23    </FONT><A NAME="23"></A><FONT ID="Import">import</FONT> java.awt.event.KeyListener;
<FONT ID="LN">24    </FONT><A NAME="24"></A><FONT ID="Import">import</FONT> java.awt.event.WindowAdapter;
<FONT ID="LN">25    </FONT><A NAME="25"></A><FONT ID="Import">import</FONT> java.awt.event.WindowEvent;
<FONT ID="LN">26    </FONT><A NAME="26"></A><FONT ID="Import">import</FONT> java.awt.image.BufferStrategy;
<FONT ID="LN">27    </FONT><A NAME="27"></A><FONT ID="Import">import</FONT> java.awt.image.BufferedImage;
<FONT ID="LN">28    </FONT><A NAME="28"></A><FONT ID="Import">import</FONT> java.util.ArrayList;
<FONT ID="LN">29    </FONT><A NAME="29"></A>
<FONT ID="LN">30    </FONT><A NAME="30"></A><FONT ID="Import">import</FONT> javax.swing.JFrame;
<FONT ID="LN">31    </FONT><A NAME="31"></A><FONT ID="Import">import</FONT> javax.swing.JPanel;
<FONT ID="LN">32    </FONT><A NAME="32"></A>
<FONT ID="LN">33    </FONT><A NAME="33"></A><FONT ID="Public">public</FONT> <FONT ID="Class">class</FONT> Invaders <FONT ID="Extends">extends</FONT> Canvas <FONT ID="Implements">implements</FONT> <A TITLE='Java Source' HREF="version29/Stage.java.html">Stage</A>, KeyListener {
<FONT ID="LN">34    </FONT><A NAME="34"></A>  
<FONT ID="LN">35    </FONT><A NAME="35"></A>  <FONT ID="Private">private</FONT> BufferStrategy strategy;
<FONT ID="LN">36    </FONT><A NAME="36"></A>  <FONT ID="Private">private</FONT> <FONT ID="Long">long</FONT> usedTime;
<FONT ID="LN">37    </FONT><A NAME="37"></A>  
<FONT ID="LN">38    </FONT><A NAME="38"></A>  <FONT ID="Private">private</FONT> <A TITLE='Java Source' HREF="version29/SpriteCache.java.html">SpriteCache</A> spriteCache;
<FONT ID="LN">39    </FONT><A NAME="39"></A>  <FONT ID="Private">private</FONT> <A TITLE='Java Source' HREF="version29/SoundCache.java.html">SoundCache</A> soundCache;
<FONT ID="LN">40    </FONT><A NAME="40"></A>  <FONT ID="Private">private</FONT> ArrayList actors; 
<FONT ID="LN">41    </FONT><A NAME="41"></A>  <FONT ID="Private">private</FONT> <A TITLE='Java Source' HREF="version29/Player.java.html">Player</A> player;
<div class='cambio'>
<FONT ID="LN">42    </FONT><A NAME="42"></A>  <FONT ID="Private">private</FONT> BufferedImage background, backgroundTile;
<FONT ID="LN">43    </FONT><A NAME="43"></A>  <FONT ID="Private">private</FONT> <FONT ID="Int">int</FONT> backgroundY;
</div>
<FONT ID="LN">44    </FONT><A NAME="44"></A>  
<FONT ID="LN">45    </FONT><A NAME="45"></A>  <FONT ID="Private">private</FONT> <FONT ID="Boolean">boolean</FONT> gameEnded=<FONT ID="False">false</FONT>;
<FONT ID="LN">46    </FONT><A NAME="46"></A>  
<FONT ID="LN">47    </FONT><A NAME="47"></A>  <FONT ID="Public">public</FONT> Invaders() {
<FONT ID="LN">48    </FONT><A NAME="48"></A>    spriteCache = <FONT ID="New">new</FONT> <A TITLE='Java Source' HREF="version29/SpriteCache.java.html">SpriteCache</A>();
<FONT ID="LN">49    </FONT><A NAME="49"></A>    soundCache = <FONT ID="New">new</FONT> <A TITLE='Java Source' HREF="version29/SoundCache.java.html">SoundCache</A>();
<FONT ID="LN">50    </FONT><A NAME="50"></A>    
<FONT ID="LN">51    </FONT><A NAME="51"></A>    
<FONT ID="LN">52    </FONT><A NAME="52"></A>    JFrame ventana = <FONT ID="New">new</FONT> JFrame(<FONT ID="StringLiteral">"Invaders"</FONT>);
<FONT ID="LN">53    </FONT><A NAME="53"></A>    JPanel panel = (JPanel)ventana.getContentPane();
<FONT ID="LN">54    </FONT><A NAME="54"></A>    setBounds(<FONT ID="IntegerLiteral">0</FONT>,<FONT ID="IntegerLiteral">0</FONT>,Stage.WIDTH,Stage.HEIGHT);
<FONT ID="LN">55    </FONT><A NAME="55"></A>    panel.setPreferredSize(<FONT ID="New">new</FONT> Dimension(Stage.WIDTH,Stage.HEIGHT));
<FONT ID="LN">56    </FONT><A NAME="56"></A>    panel.setLayout(<FONT ID="Null">null</FONT>);
<FONT ID="LN">57    </FONT><A NAME="57"></A>    panel.add(<FONT ID="This">this</FONT>);
<FONT ID="LN">58    </FONT><A NAME="58"></A>    ventana.setBounds(<FONT ID="IntegerLiteral">0</FONT>,<FONT ID="IntegerLiteral">0</FONT>,Stage.WIDTH,Stage.HEIGHT);
<FONT ID="LN">59    </FONT><A NAME="59"></A>    ventana.setVisible(<FONT ID="True">true</FONT>);
<FONT ID="LN">60    </FONT><A NAME="60"></A>    ventana.addWindowListener( <FONT ID="New">new</FONT> WindowAdapter() {
<FONT ID="LN">61    </FONT><A NAME="61"></A>      <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> windowClosing(WindowEvent e) {
<FONT ID="LN">62    </FONT><A NAME="62"></A>        System.exit(<FONT ID="IntegerLiteral">0</FONT>);
<FONT ID="LN">63    </FONT><A NAME="63"></A>      }
<FONT ID="LN">64    </FONT><A NAME="64"></A>    });
<FONT ID="LN">65    </FONT><A NAME="65"></A>    ventana.setResizable(<FONT ID="False">false</FONT>);
<FONT ID="LN">66    </FONT><A NAME="66"></A>    createBufferStrategy(<FONT ID="IntegerLiteral">2</FONT>);
<FONT ID="LN">67    </FONT><A NAME="67"></A>    strategy = getBufferStrategy();
<FONT ID="LN">68    </FONT><A NAME="68"></A>    requestFocus();
<FONT ID="LN">69    </FONT><A NAME="69"></A>    addKeyListener(<FONT ID="This">this</FONT>);
<FONT ID="LN">70    </FONT><A NAME="70"></A>    
<FONT ID="LN">71    </FONT><A NAME="71"></A>    setIgnoreRepaint(<FONT ID="True">true</FONT>);
<FONT ID="LN">72    </FONT><A NAME="72"></A>    
<FONT ID="LN">73    </FONT><A NAME="73"></A>    BufferedImage cursor = spriteCache.createCompatible(<FONT ID="IntegerLiteral">10</FONT>,<FONT ID="IntegerLiteral">10</FONT>,Transparency.BITMASK);
<FONT ID="LN">74    </FONT><A NAME="74"></A>    Toolkit t = Toolkit.getDefaultToolkit();
<FONT ID="LN">75    </FONT><A NAME="75"></A>    Cursor c = t.createCustomCursor(cursor,<FONT ID="New">new</FONT> Point(<FONT ID="IntegerLiteral">5</FONT>,<FONT ID="IntegerLiteral">5</FONT>),<FONT ID="StringLiteral">"null"</FONT>);
<FONT ID="LN">76    </FONT><A NAME="76"></A>    setCursor(c);
<FONT ID="LN">77    </FONT><A NAME="77"></A>  }
<FONT ID="LN">78    </FONT><A NAME="78"></A>  
<FONT ID="LN">79    </FONT><A NAME="79"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> gameOver() {
<FONT ID="LN">80    </FONT><A NAME="80"></A>    gameEnded = <FONT ID="True">true</FONT>;
<FONT ID="LN">81    </FONT><A NAME="81"></A>  }
<FONT ID="LN">82    </FONT><A NAME="82"></A>  
<FONT ID="LN">83    </FONT><A NAME="83"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> initWorld() {
<FONT ID="LN">84    </FONT><A NAME="84"></A>    actors = <FONT ID="New">new</FONT> ArrayList();
<FONT ID="LN">85    </FONT><A NAME="85"></A>    <FONT ID="For">for</FONT> (<FONT ID="Int">int</FONT> i = <FONT ID="IntegerLiteral">0</FONT>; i &lt; <FONT ID="IntegerLiteral">10</FONT>; i++){
<FONT ID="LN">86    </FONT><A NAME="86"></A>      <A TITLE='Java Source' HREF="version29/Monster.java.html">Monster</A> m = <FONT ID="New">new</FONT> <A TITLE='Java Source' HREF="version29/Monster.java.html">Monster</A>(<FONT ID="This">this</FONT>);
<FONT ID="LN">87    </FONT><A NAME="87"></A>      m.setX( (<FONT ID="Int">int</FONT>)(Math.random()*Stage.WIDTH) );
<FONT ID="LN">88    </FONT><A NAME="88"></A>      m.setY( i*<FONT ID="IntegerLiteral">20</FONT> );
<FONT ID="LN">89    </FONT><A NAME="89"></A>      m.setVx( (<FONT ID="Int">int</FONT>)(Math.random()*<FONT ID="IntegerLiteral">20</FONT>-<FONT ID="IntegerLiteral">10</FONT>) );
<FONT ID="LN">90    </FONT><A NAME="90"></A>      
<FONT ID="LN">91    </FONT><A NAME="91"></A>      actors.add(m);
<FONT ID="LN">92    </FONT><A NAME="92"></A>    }
<FONT ID="LN">93    </FONT><A NAME="93"></A>    
<FONT ID="LN">94    </FONT><A NAME="94"></A>    player = <FONT ID="New">new</FONT> <A TITLE='Java Source' HREF="version29/Player.java.html">Player</A>(<FONT ID="This">this</FONT>);
<FONT ID="LN">95    </FONT><A NAME="95"></A>    player.setX(Stage.WIDTH/<FONT ID="IntegerLiteral">2</FONT>);
<FONT ID="LN">96    </FONT><A NAME="96"></A>    player.setY(Stage.PLAY_HEIGHT - <FONT ID="IntegerLiteral">2</FONT>*player.getHeight());
<FONT ID="LN">97    </FONT><A NAME="97"></A>    
<FONT ID="LN">98    </FONT><A NAME="98"></A>    soundCache.loopSound(<FONT ID="StringLiteral">"musica.wav"</FONT>);
<FONT ID="LN">99    </FONT><A NAME="99"></A>    
<div class='cambio'>
<FONT ID="LN">100   </FONT><A NAME="100"></A>    backgroundTile = spriteCache.getSprite(<FONT ID="StringLiteral">"oceano.gif"</FONT>);
<FONT ID="LN">101   </FONT><A NAME="101"></A>    background = spriteCache.createCompatible(
<FONT ID="LN">102   </FONT><A NAME="102"></A>                 Stage.WIDTH,  
<FONT ID="LN">103   </FONT><A NAME="103"></A>                 Stage.HEIGHT+backgroundTile.getHeight(),
<FONT ID="LN">104   </FONT><A NAME="104"></A>                 Transparency.OPAQUE);
<FONT ID="LN">105   </FONT><A NAME="105"></A>    Graphics2D g = (Graphics2D)background.getGraphics();
<FONT ID="LN">106   </FONT><A NAME="106"></A>    g.setPaint( <FONT ID="New">new</FONT> TexturePaint( backgroundTile, 
<FONT ID="LN">107   </FONT><A NAME="107"></A>                                  <FONT ID="New">new</FONT> Rectangle(<FONT ID="IntegerLiteral">0</FONT>,<FONT ID="IntegerLiteral">0</FONT>,backgroundTile.getWidth(),backgroundTile.getHeight())));
<FONT ID="LN">108   </FONT><A NAME="108"></A>    g.fillRect(<FONT ID="IntegerLiteral">0</FONT>,<FONT ID="IntegerLiteral">0</FONT>,background.getWidth(),background.getHeight());
<FONT ID="LN">109   </FONT><A NAME="109"></A>    backgroundY = backgroundTile.getHeight();
<FONT ID="LN">110   </FONT><A NAME="110"></A>    
</div>
<FONT ID="LN">111   </FONT><A NAME="111"></A>  }
<FONT ID="LN">112   </FONT><A NAME="112"></A>  
<FONT ID="LN">113   </FONT><A NAME="113"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> addActor(<A TITLE='Java Source' HREF="version29/Actor.java.html">Actor</A> a) {
<FONT ID="LN">114   </FONT><A NAME="114"></A>    actors.add(a);
<FONT ID="LN">115   </FONT><A NAME="115"></A>  } 
<FONT ID="LN">116   </FONT><A NAME="116"></A>  
<FONT ID="LN">117   </FONT><A NAME="117"></A>  <FONT ID="Public">public</FONT> <A TITLE='Java Source' HREF="version29/Player.java.html">Player</A> getPlayer() {
<FONT ID="LN">118   </FONT><A NAME="118"></A>    <FONT ID="Return">return</FONT> player;
<FONT ID="LN">119   </FONT><A NAME="119"></A>  }
<FONT ID="LN">120   </FONT><A NAME="120"></A>  
<FONT ID="LN">121   </FONT><A NAME="121"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> updateWorld() {
<FONT ID="LN">122   </FONT><A NAME="122"></A>    <FONT ID="Int">int</FONT> i = <FONT ID="IntegerLiteral">0</FONT>;
<FONT ID="LN">123   </FONT><A NAME="123"></A>    <FONT ID="While">while</FONT> (i &lt; actors.size()) {
<FONT ID="LN">124   </FONT><A NAME="124"></A>      <A TITLE='Java Source' HREF="version29/Actor.java.html">Actor</A> m = (<A TITLE='Java Source' HREF="version29/Actor.java.html">Actor</A>)actors.get(i);
<FONT ID="LN">125   </FONT><A NAME="125"></A>      <FONT ID="If">if</FONT> (m.isMarkedForRemoval()) {
<FONT ID="LN">126   </FONT><A NAME="126"></A>        actors.remove(i);
<FONT ID="LN">127   </FONT><A NAME="127"></A>      } <FONT ID="Else">else</FONT> {
<FONT ID="LN">128   </FONT><A NAME="128"></A>        m.act();
<FONT ID="LN">129   </FONT><A NAME="129"></A>        i++;
<FONT ID="LN">130   </FONT><A NAME="130"></A>      }
<FONT ID="LN">131   </FONT><A NAME="131"></A>    }
<FONT ID="LN">132   </FONT><A NAME="132"></A>    player.act();
<FONT ID="LN">133   </FONT><A NAME="133"></A>  }
<FONT ID="LN">134   </FONT><A NAME="134"></A>  
<FONT ID="LN">135   </FONT><A NAME="135"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> checkCollisions() {
<FONT ID="LN">136   </FONT><A NAME="136"></A>    Rectangle playerBounds = player.getBounds();
<FONT ID="LN">137   </FONT><A NAME="137"></A>    <FONT ID="For">for</FONT> (<FONT ID="Int">int</FONT> i = <FONT ID="IntegerLiteral">0</FONT>; i &lt; actors.size(); i++) {
<FONT ID="LN">138   </FONT><A NAME="138"></A>      <A TITLE='Java Source' HREF="version29/Actor.java.html">Actor</A> a1 = (<A TITLE='Java Source' HREF="version29/Actor.java.html">Actor</A>)actors.get(i);
<FONT ID="LN">139   </FONT><A NAME="139"></A>      Rectangle r1 = a1.getBounds();
<FONT ID="LN">140   </FONT><A NAME="140"></A>      <FONT ID="If">if</FONT> (r1.intersects(playerBounds)) {
<FONT ID="LN">141   </FONT><A NAME="141"></A>        player.collision(a1);
<FONT ID="LN">142   </FONT><A NAME="142"></A>        a1.collision(player);
<FONT ID="LN">143   </FONT><A NAME="143"></A>      }
<FONT ID="LN">144   </FONT><A NAME="144"></A>      <FONT ID="For">for</FONT> (<FONT ID="Int">int</FONT> j = i+<FONT ID="IntegerLiteral">1</FONT>; j &lt; actors.size(); j++) {
<FONT ID="LN">145   </FONT><A NAME="145"></A>        <A TITLE='Java Source' HREF="version29/Actor.java.html">Actor</A> a2 = (<A TITLE='Java Source' HREF="version29/Actor.java.html">Actor</A>)actors.get(j);
<FONT ID="LN">146   </FONT><A NAME="146"></A>        Rectangle r2 = a2.getBounds();
<FONT ID="LN">147   </FONT><A NAME="147"></A>        <FONT ID="If">if</FONT> (r1.intersects(r2)) {
<FONT ID="LN">148   </FONT><A NAME="148"></A>          a1.collision(a2);
<FONT ID="LN">149   </FONT><A NAME="149"></A>          a2.collision(a1);
<FONT ID="LN">150   </FONT><A NAME="150"></A>        }
<FONT ID="LN">151   </FONT><A NAME="151"></A>      }
<FONT ID="LN">152   </FONT><A NAME="152"></A>    }
<FONT ID="LN">153   </FONT><A NAME="153"></A>  }
<FONT ID="LN">154   </FONT><A NAME="154"></A>  
<FONT ID="LN">155   </FONT><A NAME="155"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> paintShields(Graphics2D g) {
<FONT ID="LN">156   </FONT><A NAME="156"></A>    g.setPaint(Color.red);
<FONT ID="LN">157   </FONT><A NAME="157"></A>    g.fillRect(<FONT ID="IntegerLiteral">280</FONT>,Stage.PLAY_HEIGHT,Player.MAX_SHIELDS,<FONT ID="IntegerLiteral">30</FONT>);
<FONT ID="LN">158   </FONT><A NAME="158"></A>    g.setPaint(Color.blue);
<FONT ID="LN">159   </FONT><A NAME="159"></A>    g.fillRect(<FONT ID="IntegerLiteral">280</FONT>+Player.MAX_SHIELDS-player.getShields(),Stage.PLAY_HEIGHT,player.getShields(),<FONT ID="IntegerLiteral">30</FONT>);
<FONT ID="LN">160   </FONT><A NAME="160"></A>    g.setFont(<FONT ID="New">new</FONT> Font(<FONT ID="StringLiteral">"Arial"</FONT>,Font.BOLD,<FONT ID="IntegerLiteral">20</FONT>));
<FONT ID="LN">161   </FONT><A NAME="161"></A>    g.setPaint(Color.green);
<FONT ID="LN">162   </FONT><A NAME="162"></A>    g.drawString(<FONT ID="StringLiteral">"Shields"</FONT>,<FONT ID="IntegerLiteral">170</FONT>,Stage.PLAY_HEIGHT+<FONT ID="IntegerLiteral">20</FONT>);
<FONT ID="LN">163   </FONT><A NAME="163"></A>      
<FONT ID="LN">164   </FONT><A NAME="164"></A>  }
<FONT ID="LN">165   </FONT><A NAME="165"></A>    
<FONT ID="LN">166   </FONT><A NAME="166"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> paintScore(Graphics2D g) {
<FONT ID="LN">167   </FONT><A NAME="167"></A>    g.setFont(<FONT ID="New">new</FONT> Font(<FONT ID="StringLiteral">"Arial"</FONT>,Font.BOLD,<FONT ID="IntegerLiteral">20</FONT>));
<FONT ID="LN">168   </FONT><A NAME="168"></A>    g.setPaint(Color.green);
<FONT ID="LN">169   </FONT><A NAME="169"></A>    g.drawString(<FONT ID="StringLiteral">"Score:"</FONT>,<FONT ID="IntegerLiteral">20</FONT>,Stage.PLAY_HEIGHT + <FONT ID="IntegerLiteral">20</FONT>);
<FONT ID="LN">170   </FONT><A NAME="170"></A>    g.setPaint(Color.red);
<FONT ID="LN">171   </FONT><A NAME="171"></A>    g.drawString(player.getScore()+<FONT ID="StringLiteral">""</FONT>,<FONT ID="IntegerLiteral">100</FONT>,Stage.PLAY_HEIGHT  + <FONT ID="IntegerLiteral">20</FONT>);
<FONT ID="LN">172   </FONT><A NAME="172"></A>  }
<FONT ID="LN">173   </FONT><A NAME="173"></A>  
<FONT ID="LN">174   </FONT><A NAME="174"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> paintAmmo(Graphics2D g) {
<FONT ID="LN">175   </FONT><A NAME="175"></A>    <FONT ID="Int">int</FONT> xBase = <FONT ID="IntegerLiteral">280</FONT>+Player.MAX_SHIELDS+<FONT ID="IntegerLiteral">10</FONT>;
<FONT ID="LN">176   </FONT><A NAME="176"></A>    <FONT ID="For">for</FONT> (<FONT ID="Int">int</FONT> i = <FONT ID="IntegerLiteral">0</FONT>; i &lt; player.getClusterBombs();i++) {
<FONT ID="LN">177   </FONT><A NAME="177"></A>      BufferedImage bomb = spriteCache.getSprite(<FONT ID="StringLiteral">"bombUL.gif"</FONT>);
<FONT ID="LN">178   </FONT><A NAME="178"></A>      g.drawImage( bomb ,xBase+i*bomb.getWidth(),Stage.PLAY_HEIGHT,<FONT ID="This">this</FONT>);
<FONT ID="LN">179   </FONT><A NAME="179"></A>    }
<FONT ID="LN">180   </FONT><A NAME="180"></A>  }
<FONT ID="LN">181   </FONT><A NAME="181"></A>  
<FONT ID="LN">182   </FONT><A NAME="182"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> paintfps(Graphics2D g) {
<FONT ID="LN">183   </FONT><A NAME="183"></A>    g.setFont( <FONT ID="New">new</FONT> Font(<FONT ID="StringLiteral">"Arial"</FONT>,Font.BOLD,<FONT ID="IntegerLiteral">12</FONT>));
<FONT ID="LN">184   </FONT><A NAME="184"></A>    g.setColor(Color.white);
<FONT ID="LN">185   </FONT><A NAME="185"></A>    <FONT ID="If">if</FONT> (usedTime &gt; <FONT ID="IntegerLiteral">0</FONT>)
<FONT ID="LN">186   </FONT><A NAME="186"></A>      g.drawString(String.valueOf(<FONT ID="IntegerLiteral">1000</FONT>/usedTime)+<FONT ID="StringLiteral">" fps"</FONT>,Stage.WIDTH-<FONT ID="IntegerLiteral">50</FONT>,Stage.PLAY_HEIGHT);
<FONT ID="LN">187   </FONT><A NAME="187"></A>    <FONT ID="Else">else</FONT>
<FONT ID="LN">188   </FONT><A NAME="188"></A>      g.drawString(<FONT ID="StringLiteral">"--- fps"</FONT>,Stage.WIDTH-<FONT ID="IntegerLiteral">50</FONT>,Stage.PLAY_HEIGHT);
<FONT ID="LN">189   </FONT><A NAME="189"></A>  }
<FONT ID="LN">190   </FONT><A NAME="190"></A>  
<FONT ID="LN">191   </FONT><A NAME="191"></A>  
<FONT ID="LN">192   </FONT><A NAME="192"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> paintStatus(Graphics2D g) {
<FONT ID="LN">193   </FONT><A NAME="193"></A>    paintScore(g);
<FONT ID="LN">194   </FONT><A NAME="194"></A>    paintShields(g);
<FONT ID="LN">195   </FONT><A NAME="195"></A>    paintAmmo(g);
<FONT ID="LN">196   </FONT><A NAME="196"></A>    paintfps(g);  
<FONT ID="LN">197   </FONT><A NAME="197"></A>  }
<FONT ID="LN">198   </FONT><A NAME="198"></A>  
<FONT ID="LN">199   </FONT><A NAME="199"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> paintWorld() {
<FONT ID="LN">200   </FONT><A NAME="200"></A>    Graphics2D g = (Graphics2D)strategy.getDrawGraphics();
<div class='cambio'>
<FONT ID="LN">201   </FONT><A NAME="201"></A>    g.drawImage( background,
<FONT ID="LN">202   </FONT><A NAME="202"></A>                 <FONT ID="IntegerLiteral">0</FONT>,<FONT ID="IntegerLiteral">0</FONT>,Stage.WIDTH,Stage.HEIGHT,
<FONT ID="LN">203   </FONT><A NAME="203"></A>                 <FONT ID="IntegerLiteral">0</FONT>,backgroundY,Stage.WIDTH,backgroundY+Stage.HEIGHT,<FONT ID="This">this</FONT>);
</div>
<FONT ID="LN">204   </FONT><A NAME="204"></A>    <FONT ID="For">for</FONT> (<FONT ID="Int">int</FONT> i = <FONT ID="IntegerLiteral">0</FONT>; i &lt; actors.size(); i++) {
<FONT ID="LN">205   </FONT><A NAME="205"></A>      <A TITLE='Java Source' HREF="version29/Actor.java.html">Actor</A> m = (<A TITLE='Java Source' HREF="version29/Actor.java.html">Actor</A>)actors.get(i);
<FONT ID="LN">206   </FONT><A NAME="206"></A>      m.paint(g);
<FONT ID="LN">207   </FONT><A NAME="207"></A>    }
<FONT ID="LN">208   </FONT><A NAME="208"></A>    player.paint(g);
<FONT ID="LN">209   </FONT><A NAME="209"></A>
<FONT ID="LN">210   </FONT><A NAME="210"></A>      
<FONT ID="LN">211   </FONT><A NAME="211"></A>    paintStatus(g);
<FONT ID="LN">212   </FONT><A NAME="212"></A>    strategy.show();
<FONT ID="LN">213   </FONT><A NAME="213"></A>  }
<FONT ID="LN">214   </FONT><A NAME="214"></A>  
<FONT ID="LN">215   </FONT><A NAME="215"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> paintGameOver() {
<FONT ID="LN">216   </FONT><A NAME="216"></A>    Graphics2D g = (Graphics2D)strategy.getDrawGraphics();
<FONT ID="LN">217   </FONT><A NAME="217"></A>    g.setColor(Color.white);
<FONT ID="LN">218   </FONT><A NAME="218"></A>    g.setFont(<FONT ID="New">new</FONT> Font(<FONT ID="StringLiteral">"Arial"</FONT>,Font.BOLD,<FONT ID="IntegerLiteral">20</FONT>));
<FONT ID="LN">219   </FONT><A NAME="219"></A>    g.drawString(<FONT ID="StringLiteral">"GAME OVER"</FONT>,Stage.WIDTH/<FONT ID="IntegerLiteral">2</FONT>-<FONT ID="IntegerLiteral">50</FONT>,Stage.HEIGHT/<FONT ID="IntegerLiteral">2</FONT>);
<FONT ID="LN">220   </FONT><A NAME="220"></A>    strategy.show();
<FONT ID="LN">221   </FONT><A NAME="221"></A>  }
<FONT ID="LN">222   </FONT><A NAME="222"></A>  
<FONT ID="LN">223   </FONT><A NAME="223"></A>  <FONT ID="Public">public</FONT> <A TITLE='Java Source' HREF="version29/SpriteCache.java.html">SpriteCache</A> getSpriteCache() {
<FONT ID="LN">224   </FONT><A NAME="224"></A>    <FONT ID="Return">return</FONT> spriteCache;
<FONT ID="LN">225   </FONT><A NAME="225"></A>  }
<FONT ID="LN">226   </FONT><A NAME="226"></A>  
<FONT ID="LN">227   </FONT><A NAME="227"></A>  <FONT ID="Public">public</FONT> <A TITLE='Java Source' HREF="version29/SoundCache.java.html">SoundCache</A> getSoundCache() {
<FONT ID="LN">228   </FONT><A NAME="228"></A>    <FONT ID="Return">return</FONT> soundCache;
<FONT ID="LN">229   </FONT><A NAME="229"></A>  }
<FONT ID="LN">230   </FONT><A NAME="230"></A>  
<FONT ID="LN">231   </FONT><A NAME="231"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> keyPressed(KeyEvent e) {
<FONT ID="LN">232   </FONT><A NAME="232"></A>    player.keyPressed(e);
<FONT ID="LN">233   </FONT><A NAME="233"></A>  }
<FONT ID="LN">234   </FONT><A NAME="234"></A>  
<FONT ID="LN">235   </FONT><A NAME="235"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> keyReleased(KeyEvent e) {
<FONT ID="LN">236   </FONT><A NAME="236"></A>    player.keyReleased(e);
<FONT ID="LN">237   </FONT><A NAME="237"></A>  }
<FONT ID="LN">238   </FONT><A NAME="238"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> keyTyped(KeyEvent e) {}
<FONT ID="LN">239   </FONT><A NAME="239"></A>  
<FONT ID="LN">240   </FONT><A NAME="240"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> game() {
<FONT ID="LN">241   </FONT><A NAME="241"></A>    usedTime=<FONT ID="IntegerLiteral">1000</FONT>;
<FONT ID="LN">242   </FONT><A NAME="242"></A>    initWorld();
<FONT ID="LN">243   </FONT><A NAME="243"></A>    <FONT ID="While">while</FONT> (isVisible() &amp;&amp; !gameEnded) {
<FONT ID="LN">244   </FONT><A NAME="244"></A>      <FONT ID="Long">long</FONT> startTime = System.currentTimeMillis();
<div class='cambio'>
<FONT ID="LN">245   </FONT><A NAME="245"></A>      backgroundY--;
<FONT ID="LN">246   </FONT><A NAME="246"></A>      <FONT ID="If">if</FONT> (backgroundY &lt; <FONT ID="IntegerLiteral">0</FONT>)
<FONT ID="LN">247   </FONT><A NAME="247"></A>        backgroundY = backgroundTile.getHeight();
</div>
<FONT ID="LN">248   </FONT><A NAME="248"></A>      updateWorld();
<FONT ID="LN">249   </FONT><A NAME="249"></A>      checkCollisions();
<FONT ID="LN">250   </FONT><A NAME="250"></A>      paintWorld();
<FONT ID="LN">251   </FONT><A NAME="251"></A>      usedTime = System.currentTimeMillis()-startTime;
<FONT ID="LN">252   </FONT><A NAME="252"></A>      <FONT ID="Do">do</FONT> {
<FONT ID="LN">253   </FONT><A NAME="253"></A>        Thread.yield();
<FONT ID="LN">254   </FONT><A NAME="254"></A>      } <FONT ID="While">while</FONT> (System.currentTimeMillis()-startTime&lt; <FONT ID="IntegerLiteral">17</FONT>);
<FONT ID="LN">255   </FONT><A NAME="255"></A>    }
<FONT ID="LN">256   </FONT><A NAME="256"></A>    paintGameOver();
<FONT ID="LN">257   </FONT><A NAME="257"></A>  }
<FONT ID="LN">258   </FONT><A NAME="258"></A>  
<FONT ID="LN">259   </FONT><A NAME="259"></A>  <FONT ID="Public">public</FONT> <FONT ID="Static">static</FONT> <FONT ID="Void">void</FONT> main(String[] args) {
<FONT ID="LN">260   </FONT><A NAME="260"></A>    <A TITLE='Java Source' HREF="version29/Invaders.java.html">Invaders</A> inv = <FONT ID="New">new</FONT> <A TITLE='Java Source' HREF="version29/Invaders.java.html">Invaders</A>();
<FONT ID="LN">261   </FONT><A NAME="261"></A>    inv.game();
<FONT ID="LN">262   </FONT><A NAME="262"></A>  }
<FONT ID="LN">263   </FONT><A NAME="263"></A>}
<FONT ID="LN">264   </FONT><A NAME="264"></A>
</div>


<p>La tercera optimización consiste en librarnos del cursor del ratón:</p>

<div class='codigo'>
<TABLE id="Header" border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td colspan="2" width="33%">&nbsp;</td>
<td align="center" colspan="2" width="33%">
<font size="4">Invaders.java</font>
</td>
<td align="right" colspan="2" width="33%">&nbsp;</td>
</tr>
</TABLE>
<pre ID="Classes">

           . . .  
<FONT ID="LN">47    </FONT><A NAME="47"></A>  <FONT ID="Public">public</FONT> Invaders() {
<FONT ID="LN">48    </FONT><A NAME="48"></A>    spriteCache = <FONT ID="New">new</FONT> <A TITLE='Java Source' HREF="version29/SpriteCache.java.html">SpriteCache</A>();
<FONT ID="LN">49    </FONT><A NAME="49"></A>    soundCache = <FONT ID="New">new</FONT> <A TITLE='Java Source' HREF="version29/SoundCache.java.html">SoundCache</A>();
<FONT ID="LN">50    </FONT><A NAME="50"></A>    
<FONT ID="LN">51    </FONT><A NAME="51"></A>    
<FONT ID="LN">52    </FONT><A NAME="52"></A>    JFrame ventana = <FONT ID="New">new</FONT> JFrame(<FONT ID="StringLiteral">"Invaders"</FONT>);
<FONT ID="LN">53    </FONT><A NAME="53"></A>    JPanel panel = (JPanel)ventana.getContentPane();
<FONT ID="LN">54    </FONT><A NAME="54"></A>    setBounds(<FONT ID="IntegerLiteral">0</FONT>,<FONT ID="IntegerLiteral">0</FONT>,Stage.WIDTH,Stage.HEIGHT);
<FONT ID="LN">55    </FONT><A NAME="55"></A>    panel.setPreferredSize(<FONT ID="New">new</FONT> Dimension(Stage.WIDTH,Stage.HEIGHT));
<FONT ID="LN">56    </FONT><A NAME="56"></A>    panel.setLayout(<FONT ID="Null">null</FONT>);
<FONT ID="LN">57    </FONT><A NAME="57"></A>    panel.add(<FONT ID="This">this</FONT>);
<FONT ID="LN">58    </FONT><A NAME="58"></A>    ventana.setBounds(<FONT ID="IntegerLiteral">0</FONT>,<FONT ID="IntegerLiteral">0</FONT>,Stage.WIDTH,Stage.HEIGHT);
<FONT ID="LN">59    </FONT><A NAME="59"></A>    ventana.setVisible(<FONT ID="True">true</FONT>);
<FONT ID="LN">60    </FONT><A NAME="60"></A>    ventana.addWindowListener( <FONT ID="New">new</FONT> WindowAdapter() {
<FONT ID="LN">61    </FONT><A NAME="61"></A>      <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> windowClosing(WindowEvent e) {
<FONT ID="LN">62    </FONT><A NAME="62"></A>        System.exit(<FONT ID="IntegerLiteral">0</FONT>);
<FONT ID="LN">63    </FONT><A NAME="63"></A>      }
<FONT ID="LN">64    </FONT><A NAME="64"></A>    });
<FONT ID="LN">65    </FONT><A NAME="65"></A>    ventana.setResizable(<FONT ID="False">false</FONT>);
<FONT ID="LN">66    </FONT><A NAME="66"></A>    createBufferStrategy(<FONT ID="IntegerLiteral">2</FONT>);
<FONT ID="LN">67    </FONT><A NAME="67"></A>    strategy = getBufferStrategy();
<FONT ID="LN">68    </FONT><A NAME="68"></A>    requestFocus();
<FONT ID="LN">69    </FONT><A NAME="69"></A>    addKeyListener(<FONT ID="This">this</FONT>);
<FONT ID="LN">70    </FONT><A NAME="70"></A>    
<FONT ID="LN">71    </FONT><A NAME="71"></A>    setIgnoreRepaint(<FONT ID="True">true</FONT>);
<FONT ID="LN">72    </FONT><A NAME="72"></A>    
<div class='cambio'>
<FONT ID="LN">73    </FONT><A NAME="73"></A>    BufferedImage cursor = spriteCache.createCompatible(<FONT ID="IntegerLiteral">10</FONT>,<FONT ID="IntegerLiteral">10</FONT>,Transparency.BITMASK);
<FONT ID="LN">74    </FONT><A NAME="74"></A>    Toolkit t = Toolkit.getDefaultToolkit();
<FONT ID="LN">75    </FONT><A NAME="75"></A>    Cursor c = t.createCustomCursor(cursor,<FONT ID="New">new</FONT> Point(<FONT ID="IntegerLiteral">5</FONT>,<FONT ID="IntegerLiteral">5</FONT>),<FONT ID="StringLiteral">"null"</FONT>);
<FONT ID="LN">76    </FONT><A NAME="76"></A>    setCursor(c);
</div>
<FONT ID="LN">77    </FONT><A NAME="77"></A>  }
<FONT ID="LN">78    </FONT><A NAME="78"></A>  
           . . .  

</div>


<p>La siguiente optimización trata con un problema que es posible que nos hayamos encontrado durante el juego. Si
movemos la ventana a un segundo plano y la volvemos a poner en primer plano, veremos un parpadeo gris por unos
instantes. No es muy problemático, pero es muy poco profesional. Lo que está ocurriendo es que el AWT está lanzando
un evento de redibujo desde su propio hilo, mientras nosotros estamos haciendo otra cosa. Dado que AWT no utiliza
un doble búfer, por unos instantes vemos una pantalla gris completamente borrada - la misma situación que teníamos
nosotros al comenzar. Para evitar esto, debemos indicarle a AWT que ignore las peticiones de redibujo que provengan
del sistema operativo, ya que nosotros mismos nos estamos haciendo cargo del dibujo de la pantalla. Esto se consigue
llamando al método <span class="kw">setIgnoreRepaint()</span></p>


<div class='codigo'>
<TABLE id="Header" border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td colspan="2" width="33%">&nbsp;</td>
<td align="center" colspan="2" width="33%">
<font size="4">Invaders.java</font>
</td>
<td align="right" colspan="2" width="33%">&nbsp;</td>
</tr>
</TABLE>
<pre ID="Classes">

           . . .  
<FONT ID="LN">47    </FONT><A NAME="47"></A>  <FONT ID="Public">public</FONT> Invaders() {
<FONT ID="LN">48    </FONT><A NAME="48"></A>    spriteCache = <FONT ID="New">new</FONT> <A TITLE='Java Source' HREF="version29/SpriteCache.java.html">SpriteCache</A>();
<FONT ID="LN">49    </FONT><A NAME="49"></A>    soundCache = <FONT ID="New">new</FONT> <A TITLE='Java Source' HREF="version29/SoundCache.java.html">SoundCache</A>();
<FONT ID="LN">50    </FONT><A NAME="50"></A>    
<FONT ID="LN">51    </FONT><A NAME="51"></A>    
<FONT ID="LN">52    </FONT><A NAME="52"></A>    JFrame ventana = <FONT ID="New">new</FONT> JFrame(<FONT ID="StringLiteral">"Invaders"</FONT>);
<FONT ID="LN">53    </FONT><A NAME="53"></A>    JPanel panel = (JPanel)ventana.getContentPane();
<FONT ID="LN">54    </FONT><A NAME="54"></A>    setBounds(<FONT ID="IntegerLiteral">0</FONT>,<FONT ID="IntegerLiteral">0</FONT>,Stage.WIDTH,Stage.HEIGHT);
<FONT ID="LN">55    </FONT><A NAME="55"></A>    panel.setPreferredSize(<FONT ID="New">new</FONT> Dimension(Stage.WIDTH,Stage.HEIGHT));
<FONT ID="LN">56    </FONT><A NAME="56"></A>    panel.setLayout(<FONT ID="Null">null</FONT>);
<FONT ID="LN">57    </FONT><A NAME="57"></A>    panel.add(<FONT ID="This">this</FONT>);
<FONT ID="LN">58    </FONT><A NAME="58"></A>    ventana.setBounds(<FONT ID="IntegerLiteral">0</FONT>,<FONT ID="IntegerLiteral">0</FONT>,Stage.WIDTH,Stage.HEIGHT);
<FONT ID="LN">59    </FONT><A NAME="59"></A>    ventana.setVisible(<FONT ID="True">true</FONT>);
<FONT ID="LN">60    </FONT><A NAME="60"></A>    ventana.addWindowListener( <FONT ID="New">new</FONT> WindowAdapter() {
<FONT ID="LN">61    </FONT><A NAME="61"></A>      <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> windowClosing(WindowEvent e) {
<FONT ID="LN">62    </FONT><A NAME="62"></A>        System.exit(<FONT ID="IntegerLiteral">0</FONT>);
<FONT ID="LN">63    </FONT><A NAME="63"></A>      }
<FONT ID="LN">64    </FONT><A NAME="64"></A>    });
<FONT ID="LN">65    </FONT><A NAME="65"></A>    ventana.setResizable(<FONT ID="False">false</FONT>);
<FONT ID="LN">66    </FONT><A NAME="66"></A>    createBufferStrategy(<FONT ID="IntegerLiteral">2</FONT>);
<FONT ID="LN">67    </FONT><A NAME="67"></A>    strategy = getBufferStrategy();
<FONT ID="LN">68    </FONT><A NAME="68"></A>    requestFocus();
<FONT ID="LN">69    </FONT><A NAME="69"></A>    addKeyListener(<FONT ID="This">this</FONT>);
<FONT ID="LN">70    </FONT><A NAME="70"></A>    
<div class='cambio'>
<FONT ID="LN">71    </FONT><A NAME="71"></A>    setIgnoreRepaint(<FONT ID="True">true</FONT>);
</div>
<FONT ID="LN">72    </FONT><A NAME="72"></A>    
<FONT ID="LN">73    </FONT><A NAME="73"></A>    BufferedImage cursor = spriteCache.createCompatible(<FONT ID="IntegerLiteral">10</FONT>,<FONT ID="IntegerLiteral">10</FONT>,Transparency.BITMASK);
<FONT ID="LN">74    </FONT><A NAME="74"></A>    Toolkit t = Toolkit.getDefaultToolkit();
<FONT ID="LN">75    </FONT><A NAME="75"></A>    Cursor c = t.createCustomCursor(cursor,<FONT ID="New">new</FONT> Point(<FONT ID="IntegerLiteral">5</FONT>,<FONT ID="IntegerLiteral">5</FONT>),<FONT ID="StringLiteral">"null"</FONT>);
<FONT ID="LN">76    </FONT><A NAME="76"></A>    setCursor(c);
<FONT ID="LN">77    </FONT><A NAME="77"></A>  }
<FONT ID="LN">78    </FONT><A NAME="78"></A>  
           . . .  

</div>


<p>Finalmente, tenemos un problema con el juego y es que su velocidad varía un poco dependiendo de la velocidad
del ordenador. Dado que la pausa que hacemos es siempre la misma, si el ordenador es rápido la actualización del
escenario será rápida y el juego irá rápido. Sin embargo, si el ordenador es lento, consumirá mucho tiempo en
la actualización del escenario y <i>aún así</i> estamos esperando la misma cantidad de tiempo en el bucle
principal, con lo cual el juego va más lento. Como esto no es muy agradable lo corregiremos exigiendo que cada turno
dure cierta cantidad fija de tiempo. Esta cantidad dependerá del número de fotogramas que queremos alcanzar. Por ejemplo
si queremos 60 fts, cada turno debe durar 1000/60 = 16,66 milisegundos. De forma que en lugar de dormir siempre
la misma cantidad de tiempo (10ms), en cada turno calcularemos cuánto hemos invertido en la actualización y redibujo
de la pantalla y dormiremos el tiempo que nos quede:</p>

<div class='codigo'>
<TABLE id="Header" border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td colspan="2" width="33%">&nbsp;</td>
<td align="center" colspan="2" width="33%">
<font size="4">Invaders.java</font>
</td>
<td align="right" colspan="2" width="33%">&nbsp;</td>
</tr>
</TABLE>
<pre ID="Classes">

           . . .  
<FONT ID="LN">240   </FONT><A NAME="240"></A>  <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> game() {
<FONT ID="LN">241   </FONT><A NAME="241"></A>    usedTime=<FONT ID="IntegerLiteral">1000</FONT>;
<FONT ID="LN">242   </FONT><A NAME="242"></A>    initWorld();
<FONT ID="LN">243   </FONT><A NAME="243"></A>    <FONT ID="While">while</FONT> (isVisible() &amp;&amp; !gameEnded) {
<FONT ID="LN">244   </FONT><A NAME="244"></A>      <FONT ID="Long">long</FONT> startTime = System.currentTimeMillis();
<FONT ID="LN">245   </FONT><A NAME="245"></A>      backgroundY--;
<FONT ID="LN">246   </FONT><A NAME="246"></A>      <FONT ID="If">if</FONT> (backgroundY &lt; <FONT ID="IntegerLiteral">0</FONT>)
<FONT ID="LN">247   </FONT><A NAME="247"></A>        backgroundY = backgroundTile.getHeight();
<FONT ID="LN">248   </FONT><A NAME="248"></A>      updateWorld();
<FONT ID="LN">249   </FONT><A NAME="249"></A>      checkCollisions();
<FONT ID="LN">250   </FONT><A NAME="250"></A>      paintWorld();
<FONT ID="LN">251   </FONT><A NAME="251"></A>      usedTime = System.currentTimeMillis()-startTime;
<div class='cambio'>
<FONT ID="LN">252   </FONT><A NAME="252"></A>      <FONT ID="Do">do</FONT> {
<FONT ID="LN">253   </FONT><A NAME="253"></A>        Thread.yield();
<FONT ID="LN">254   </FONT><A NAME="254"></A>      } <FONT ID="While">while</FONT> (System.currentTimeMillis()-startTime&lt; <FONT ID="IntegerLiteral">17</FONT>);
</div>
<FONT ID="LN">255   </FONT><A NAME="255"></A>    }
<FONT ID="LN">256   </FONT><A NAME="256"></A>    paintGameOver();
<FONT ID="LN">257   </FONT><A NAME="257"></A>  }
           . . .  

</div>


<p>Bien, hemos llegado al final de este tutorial de Java. Ahora es tu turno para comenzar a hacer juegos. Si te ha
gustado este <a href="index.html">curso de java</a>, puedes poner un enlace a su índice para que otros lo puedan
disfrutar también. Si tienes algún comentario o alguna corrección o sugerencia, puedes mandarme una nota 
<a href="index.htmlemail.jsp">desde aquí</a>. Es posible que en el futuro añada más tutoriales y cursos sobre temas similares,
en cuyo caso aparecerán en la página de <a href="index.html">cursos gratuitos de Planetalia</a>.</p>


                               


<br />

<hr>
<div class="archivos">  
<h3>Lista de archivos Java del programa en este paso </h3>
<table width='80%' align='center' border='1' cellpadding='4' cellspacing='0'>
<tr >
<td width='25%' align='center'>
<a href='version29/Actor.java'>Actor.java</a>
</td>
<td width='25%' align='center'>
<a href='version29/Bomb.java'>Bomb.java</a>
</td>
<td width='25%' align='center'>
<a href='version29/Bullet.java'>Bullet.java</a>
</td>
<td width='25%' align='center'>
<a href='version29/Invaders.java'>Invaders.java</a>
</td>
</tr>
<tr >
<td width='25%' align='center'>
<a href='version29/Laser.java'>Laser.java</a>
</td>
<td width='25%' align='center'>
<a href='version29/Monster.java'>Monster.java</a>
</td>
<td width='25%' align='center'>
<a href='version29/Player.java'>Player.java</a>
</td>
<td width='25%' align='center'>
<a href='version29/ResourceCache.java'>ResourceCache.java</a>
</td>
</tr>
<tr >
<td width='25%' align='center'>
<a href='version29/SoundCache.java'>SoundCache.java</a>
</td>
<td width='25%' align='center'>
<a href='version29/SpriteCache.java'>SpriteCache.java</a>
</td>
<td width='25%' align='center'>
<a href='version29/Stage.java'>Stage.java</a>
</td>
<td width='25%' align='center'>&nbsp;</td>
</tr>
</table>

<br />
<h3>Lista de recursos</h3>
<table width='80%' align='center' border='1' cellpadding='4' cellspacing='0'>
<tr >
<td align='center'>
<a href='res/bicho.gif'>bicho.gif</a>
</td>
<td align='center'>
<a href='res/bicho0.gif'>bicho0.gif</a>
</td>
<td align='center'>
<a href='res/bicho1.gif'>bicho1.gif</a>
</td>
<td align='center'>
<a href='res/bicho2.gif'>bicho2.gif</a>
</td>
</tr>
<tr >
<td align='center'>
<a href='res/bombD.gif'>bombD.gif</a>
</td>
<td align='center'>
<a href='res/bombDL.gif'>bombDL.gif</a>
</td>
<td align='center'>
<a href='res/bombDR.gif'>bombDR.gif</a>
</td>
<td align='center'>
<a href='res/bombL.gif'>bombL.gif</a>
</td>
</tr>
<tr >
<td align='center'>
<a href='res/bombR.gif'>bombR.gif</a>
</td>
<td align='center'>
<a href='res/bombU.gif'>bombU.gif</a>
</td>
<td align='center'>
<a href='res/bombUL.gif'>bombUL.gif</a>
</td>
<td align='center'>
<a href='res/bombUR.gif'>bombUR.gif</a>
</td>
</tr>
<tr >
<td align='center'>
<a href='res/disparo.gif'>disparo.gif</a>
</td>
<td align='center'>
<a href='res/disparo0.gif'>disparo0.gif</a>
</td>
<td align='center'>
<a href='res/disparo1.gif'>disparo1.gif</a>
</td>
<td align='center'>
<a href='res/disparo2.gif'>disparo2.gif</a>
</td>
</tr>
<tr >
<td align='center'>
<a href='res/explosion.wav'>explosion.wav</a>
</td>
<td align='center'>
<a href='res/misil.gif'>misil.gif</a>
</td>
<td align='center'>
<a href='res/missile.wav'>missile.wav</a>
</td>
<td align='center'>
<a href='res/musica.wav'>musica.wav</a>
</td>
</tr>
<tr >
<td align='center'>
<a href='res/nave.gif'>nave.gif</a>
</td>
<td align='center'>
<a href='res/oceano.gif'>oceano.gif</a>
</td>
<td align='center'>
<a href='res/photon.wav'>photon.wav</a>
</td>
<td align='center'>
<a href='res/Thumbs.db'>Thumbs.db</a>
</td>
</tr>
</table>

<br />
</div>
<table border="0" width="100%">
<tr>
  <td width="33%" align="center">&nbsp;
    
    <a href="JAVA-INVADERS-28.html"> 
    
    Página Anterior - 
    
    Corrigiendo los fallos de sonido
    </a>
   
  </td>
  <td width="33%" align="center"><b>
    
    Página Actual - 
    
    29 - Pequeñas optimizaciones</b>
  </td>
  <td width="33%" align="center">&nbsp;
    
  </td>    
</tr>
<tr>
<tr>
  <td>&nbsp;</td>
  <td align="center"><a href="index.html">Índice del curso</a></td>
  <td>&nbsp;</td>
</tr>
</table>

<p class="pie">(c) 2004 Planetalia S.L. Todos los derechos reservados. Prohibida su reproducción</p>
</html>



